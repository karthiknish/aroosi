---
description: Enforce API calls through utility functions, not direct fetch in components/pages
globs: apps/web/src/**/*.{ts,tsx}
alwaysApply: true
---

# API Call Pattern Enforcement

**All API calls must be made through utility functions, not direct fetch() calls in components or pages.**

## **Rules**

- **❌ NEVER use `fetch()` directly in:**
  - Page components (`app/**/*.tsx`)
  - React components (`components/**/*.tsx`)
  - Context providers (`contexts/**/*.tsx`)

- **✅ ALWAYS use API clients from:**
  - `/lib/api/admin/profiles.ts` - Admin profile operations
  - `/lib/api/admin/matches.ts` - Admin match operations
  - `/lib/api/admin/blog.ts` - Admin blog operations
  - `/lib/api/admin/contact.ts` - Admin contact operations
  - `/lib/api/admin/email.ts` - Admin email operations
  - `/lib/api/admin/push.ts` - Admin push notification operations
  - `/lib/api/blog.ts` - Public blog operations
  - `/lib/api/contact.ts` - Public contact operations
  - `/lib/api/profile.ts` - User profile operations
  - `/lib/api/interests.ts` - User interest operations
  - `/lib/api/subscription.ts` - Payment and subscription operations
  - `/lib/api/search.ts` - Search operations
  - `/lib/utils/imageUtil.ts` - Image upload/delete/reorder

## **Available API Clients**

### **Admin Operations**
```typescript
import { adminProfilesAPI } from "@/lib/api/admin/profiles";
import { adminMatchesAPI } from "@/lib/api/admin/matches";
import { adminBlogAPI } from "@/lib/api/admin/blog";
import { adminContactAPI } from "@/lib/api/admin/contact";
import { adminEmailAPI } from "@/lib/api/admin/email";
import { adminPushAPI } from "@/lib/api/admin/push";

// Example usage:
const profiles = await adminProfilesAPI.list({ page: 1, pageSize: 20 });
const match = await adminMatchesAPI.create(profileAId, profileBId);
```

### **Public Operations**
```typescript
import { blogAPI } from "@/lib/api/blog";
import { contactAPI } from "@/lib/api/contact";

// Example usage:
const posts = await blogAPI.getPosts({ limit: 10 });
const result = await contactAPI.submitContact(formData);
```

### **User Operations**
```typescript
import { profileAPI } from "@/lib/api/profile";
import { interestsAPI } from "@/lib/api/interests";
import { subscriptionAPI } from "@/lib/api/subscription";
import { searchAPI } from "@/lib/api/search";

// Example usage:
const profile = await profileAPI.get();
await interestsAPI.send(targetUserId);
const plans = await subscriptionAPI.getPlans();
const results = await searchAPI.search(filters);
```

## **Common Violations & Fixes**

### **❌ Bad: Direct fetch in component**
```typescript
// DON'T DO THIS
const handleSubmit = async () => {
  const response = await fetch("/api/profile", {
    method: "POST",
    headers: { "Authorization": `Bearer ${token}` },
    body: JSON.stringify(data)
  });
};
```

### **✅ Good: Use utility function**
```typescript
// DO THIS INSTEAD
import { submitProfile } from "@/lib/profile/userProfileApi";

const handleSubmit = async () => {
  const result = await submitProfile(token, data, "edit");
  if (result.success) {
    // handle success
  }
};
```

## **Benefits of This Pattern**

- **Consistency**: All API calls follow the same pattern
- **Error Handling**: Centralized error handling and toast notifications
- **Type Safety**: Proper TypeScript interfaces for all API responses
- **Reusability**: Utility functions can be used across multiple components
- **Testing**: Easier to mock and test API operations
- **Maintenance**: Single place to update API endpoints and logic

## **Creating New Utility Functions**

When adding new API endpoints, create utility functions in the appropriate file:

```typescript
// Example: New utility function
export async function newApiOperation(
  token: string,
  data: SomeType
): Promise<ApiResponse<ResultType>> {
  try {
    const response = await fetch("/api/new-endpoint", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`,
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || `HTTP ${response.status}`);
    }

    const result = await response.json();
    return { success: true, data: result };
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : "Operation failed";
    showErrorToast(errorMessage);
    return { success: false, error: errorMessage };
  }
}
```

## **Exceptions**

The only acceptable places for direct `fetch()` calls are:
- API route handlers (`app/api/**/*.ts`)
- Utility functions in `/lib/**/*.ts`
- Server-side functions (not client components)